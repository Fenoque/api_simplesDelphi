unit Service.Produtos;


interface

uses
  System.SysUtils,
  System.JSON,
  DataSet.Serialize,
  FireDAC.Comp.Client,
  FireDAC.Stan.Param,
  FireDAC.Stan.Option,
  FireDAC.Stan.Intf,
  Data.DB,
  Service.Base,
  System.Generics.Collections,
  Horse;

type
  TServiceProdutos = class(TServiceBase)
  public
    procedure ListarProdutos(AParametros: TDictionary<string, string>);
    procedure LocalizarProdutoPorId(AIdPrd: Integer);
    procedure CadastroProduto(ABody: TJSONObject);
    procedure EditarProduto(AIdProd: Integer; ABody: TJSONObject);
    procedure PesquisarProduto(AParametros: TDictionary<string, string>);
    procedure ListarImagens(AIdPrd: Integer);
  end;


implementation

{ TServiceProdutos }

procedure TServiceProdutos.CadastroProduto(ABody: TJSONObject);
var
  LFDQuery, LQueryCodigo: TFDQuery;
  LCodigoBarras: string;

  LQueryUpdate: TFDQuery;
  LPreco: Double;
  LIdProduto: Integer;
begin
  LFDQuery := TFDQuery.Create(nil);
  LQueryCodigo := TFDQuery.Create(nil);
  LQueryUpdate := TFDQuery.Create(nil);

  try
    try
       LPreco := 0;
      if ABody.TryGetValue<Double>('preco', LPreco) then
      begin
        //valor da variável atualizado acima caso ele encontre, devido a isso não é necessário realizar tarefa nesse ponto da lógica.
      end
      else
      begin
        LPreco := -1;
      end;

      LQueryCodigo.Connection := Connection;
      LQueryCodigo.SQL.Text :=
        'SELECT MAX(id_prd) + 1 AS prox_id FROM produtos';
      LQueryCodigo.Open;

      LQueryCodigo.Close;
      LQueryCodigo.SQL.Text :=
        'SELECT CodigoBarrasGerado ' +
        'FROM GERAR_CODIGO_BARRAS(' +
        '  NULL, ' +
        '  NULL, ' +
        '  NULL, ' +
        '  NULL' +
        ')';

      LQueryCodigo.Open;

      if LQueryCodigo.IsEmpty then
        raise Exception.Create('Não foi possível gerar código de barras');

      LCodigoBarras := LQueryCodigo.FieldByName('CodigoBarrasGerado').AsString;

      LFDQuery.Connection := Connection;
      LFDQuery.SQL.Text :=
              'INSERT INTO produtos( '+
              '  descricao_prd, '+
              '  codigo_prd, '+
              '  tipo_prd, '+
              '  fracionado_prd, '+
              '  kit_prd, '+
              '  pesado_prd, '+
              '  id_org, '+
              '  controla_estoque_prd, '+
              '  status_prd)'+
              'VALUES('+
              '  :nome,'+
              '  :codigo_prd,' +
              '  :tipo_prd,'+
              '  :fracionado_prd,'+
              '  :kit_prd,'+
              '  :pesado_prd,'+
              '  :id_org,'+
              '  :controla_estoque_prd,'+
              '  :status_prd) '+
              'RETURNING id_prd';

      LFDQuery.ParamByName('nome').AsString := ABody.GetValue<string>('nome');
      LFDQuery.ParamByName('codigo_prd').AsString := LCodigoBarras;
      LFDQuery.ParamByName('tipo_prd').AsString := 'R';
      LFDQuery.ParamByName('fracionado_prd').AsString := 'S';
      LFDQuery.ParamByName('kit_prd').AsString := 'N';
      LFDQuery.ParamByName('pesado_prd').AsString := 'N';
      LFDQuery.ParamByName('id_org').AsString := '0';
      LFDQuery.ParamByName('controla_estoque_prd').AsString := 'S';
      LFDQuery.ParamByName('status_prd').AsString := 'A';

      LFDQuery.Open;

      LIdProduto := LFDQuery.FieldByName('id_prd').AsInteger;
      JSONObject := LFDQuery.ToJSONObject;

      if LPreco > 0 then
      begin
        LQueryUpdate.Connection := Connection;
        LQueryUpdate.SQL.Text :=
          ' UPDATE almoxarifados_estoque ' +
          ' SET preco_venda_ale = :preco ' +
          ' WHERE id_prd = :id_prd';

        LQueryUpdate.ParamByName('id_prd').AsInteger := LIdProduto;
        LQueryUpdate.ParamByName('preco').AsFloat := LPreco;
        LQueryUpdate.ExecSQL;
      end;

    except
      on E: Exception do
        raise EHorseException.New.Error('Erro ao cadastrar produto: ' + E.Message).Code(99);
    end;
  finally
    FreeAndNil(LFDQuery);
  end;

end;

procedure TServiceProdutos.EditarProduto(AIdProd: Integer; ABody: TJSONObject);
var
  LFDQuery: TFDQuery;
begin
  try
    LFDQuery := TFDQuery.Create(nil);
    try
      LFDQuery.Connection := Connection;
      LFDQuery.SQL.Text :=
      ' update PRODUTOS '+
      '   set '+
      '     codigo_prd = :codigo_prd, '+
      '     referencia_prd = :referencia_prd, '+
      '     descricao_prd = :descricao_prd, '+
      '     unidade_venda_prd = :unidade_venda_prd, '+
      '     ncm_prd = :ncm_prd, '+
      '     status_prd = :status_prd '+
      '   where (ID_PRD = :ID_PRD) '
      ;
      LFDQuery.ParamByName('codigo_prd').AsString := ABody.GetValue<string>('codigo_prd');
      LFDQuery.ParamByName('referencia_prd').AsString := ABody.GetValue<string>('referencia_prd');
      LFDQuery.ParamByName('descricao_prd').AsString := ABody.GetValue<string>('descricao_prd');
      LFDQuery.ParamByName('unidade_venda_prd').AsString := ABody.GetValue<string>('unidade_venda_prd');
      LFDQuery.ParamByName('ncm_prd').AsString := ABody.GetValue<string>('ncm_prd');
      LFDQuery.ParamByName('status_prd').AsString := ABody.GetValue<string>('status_prd');
      LFDQuery.ParamByName('id_prd').AsInteger := AIdProd;
      LFDQuery.ExecSQL();
    except
      on E: Exception do
        raise EHorseException.New.Error('Erro ao cadastrar produto: ' + E.Message).Code(99);
    end;
  finally
    FreeAndNil(LFDQuery);
  end;

end;

procedure TServiceProdutos.ListarImagens(AIdPrd: Integer);
var
  LFDQuery: TFDQuery;
begin
  LFDQuery := TFDQuery.Create(nil);
  try
    LFDQuery.Connection := Connection;
    LFDQuery.SQL.Text :=
    ' SELECT '+
    '   prd.id_prd, '+
    '   prd.descricao_prd, '+
    '   prd.unidade_venda_prd, '+
    '   CASE  '+
    '     WHEN (CURRENT_DATE BETWEEN ale.inicio_promocao_ale AND ale.fim_promocao_ale)  '+
    '          AND (ale.preco_promocao_ale > 0) '+
    '     THEN ale.preco_promocao_ale '+
    '     ELSE ale.preco_venda_ale '+
    '   END AS preco_vigente, '+
    '   prd.url_imagem_prd '+
    ' FROM produtos prd '+
    ' INNER JOIN almoxarifados_estoque ale ON ale.id_prd = prd.id_prd '+
    ' WHERE prd.id_prd = :id_prd  '+
    '   AND prd.visivel_ecommerce_prd = TRUE '+
    '   AND ale.id_alm = :id_alm; '
    ;
    LFDQuery.ParamByName('id_prd').AsInteger := AIdPrd;
    LFDQuery.ParamByName('id_alm').AsInteger := 1; // ALTERAR PARA CONSTANTE
    LFDQuery.Open;
  except
    raise EHorseException.New.Error('Ocorreu um erro no servidor!').Code(99);
  end;
  JSONObject := LFDQuery.ToJSONObject();
end;

procedure TServiceProdutos.ListarProdutos(AParametros: TDictionary<string, string>);
var
  LFDQuery: TFDQuery;
begin
  LFDQuery := TFDQuery.Create(nil);

  try
    try
      LFDQuery.Connection := Connection;

      LFDQuery.SQL.Text :=
      ' SELECT '+
      '   prd.id_prd AS id, '+
      '   prd.codigo_prd AS codigo, '+
      '   prd.referencia_prd AS referencia, '+
      '   prd.descricao_prd AS descricao, '+
      '   prd.unidade_venda_prd AS unidade, '+
      '   prd.ncm_prd AS ncm, '+
      '   prd.status_prd AS status, '+
      '   ale.quantidade_atual_ale AS estoque, '+
      '   ale.preco_venda_ale, '+
      '   ale.preco_venda2_ale, '+
      '   ale.preco_venda3_ale, '+
      '   ale.preco_promocao_ale, '+
//      '   ale.preco_promocao2_ale, '+
//      '   ale.preco_promocao3_ale, '+
      '   ale.inicio_promocao_ale, '+
//      '   ale.inicio_promocao2_ale, '+
//      '   ale.inicio_promocao3_ale, '+
      '   ale.fim_promocao_ale '+
//      '   ale.fim_promocao2_ale, '+
//      '   ale.fim_promocao3_ale '+
      ' FROM produtos prd '+
      ' INNER JOIN almoxarifados_estoque ale ON ale.id_prd = prd.id_prd '+
      ' WHERE 1=1 AND ale.id_alm = 1 ';


        if AParametros.ContainsKey('descricao') then
        begin
          LFDQuery.SQL.Add(' AND prd.descricao_prd CONTAINING :descricao ');
          LFDQuery.ParamByName('descricao').AsString := AParametros.Items['descricao'];
        end;

        if AParametros.ContainsKey('referencia') then
        begin
          LFDQuery.SQL.Add(' AND prd.referencia_prd CONTAINING :referencia ');
          LFDQuery.ParamByName('referencia').AsString := AParametros.Items['referencia'];
        end;

        if AParametros.ContainsKey('status') then
        begin
          LFDQuery.SQL.Add(' AND prd.status_prd = :status ');
          LFDQuery.ParamByName('status').AsString := AParametros.Items['status'];
        end;

        if AParametros.ContainsKey('preco1') then
        begin
          LFDQuery.SQL.Add(' AND ale.preco_venda_ale = :preco1 ');
          LFDQuery.ParamByName('preco1').AsCurrency := StrToCurr(AParametros.Items['preco1']);
        end;

//      if(AParametros.ContainsKey('limit'))then
//      begin
//        LFDQuery.SQL.Add('AND max = :limit');
//        LFDQuery.ParamByName('limit').AsString := AParametros.Items['limit'];
//      end;


      LFDQuery.Open;
      JSONArray := LFDQuery.ToJSONArray;
    except
      raise EHorseException.New.Error('Ocorreu um erro no servidor!').Code(99)
    end;
  finally
    FreeAndNil(LFDQuery);
  end;

end;

procedure TServiceProdutos.LocalizarProdutoPorId(AIdPrd: Integer);
var
  LFDQuery: TFDQuery;
begin
  LFDQuery := TFDQuery.Create(nil);
  try
    LFDQuery.Connection := Connection;
    LFDQuery.SQL.Text :=
    ' SELECT '+
      '   prd.id_prd AS id, '+
      '   prd.codigo_prd AS codigo, '+
      '   prd.referencia_prd AS referencia, '+
      '   prd.descricao_prd AS descricao, '+
      '   prd.unidade_venda_prd AS unidade, '+
      '   prd.ncm_prd AS ncm, '+
      '   prd.status_prd AS status, '+
      '   ale.quantidade_atual_ale AS estoque, '+
      '   ale.preco_venda_ale, '+
      '   ale.preco_venda2_ale, '+
      '   ale.preco_venda3_ale, '+
      '   ale.preco_promocao_ale, '+
      '   ale.preco_promocao2_ale, '+
      '   ale.preco_promocao3_ale, '+
      '   ale.inicio_promocao_ale, '+
      '   ale.inicio_promocao2_ale, '+
      '   ale.inicio_promocao3_ale, '+
      '   ale.fim_promocao_ale, '+
      '   ale.fim_promocao2_ale, '+
      '   ale.fim_promocao3_ale '+
      ' FROM produtos prd '+
      ' INNER JOIN almoxarifados_estoque ale ON ale.id_prd = prd.id_prd '+
      ' where prd.id_prd = :id_prd AND ale.id_alm = :id_alm '
    ;
    LFDQuery.ParamByName('id_prd').AsInteger := AIdPrd;
    LFDQuery.ParamByName('id_alm').AsInteger := 1; // ALTERAR
    LFDQuery.Open;
  except
    raise EHorseException.New.Error('Ocorreu um erro no servidor!').Code(99);
  end;
  JSONObject := LFDQuery.ToJSONObject();

end;

procedure TServiceProdutos.PesquisarProduto(
  AParametros: TDictionary<string, string>);
var
  LFDQuery: TFDQuery;
begin
  LFDQuery := TFDQuery.Create(nil);

  try
    try
      LFDQuery.Connection := Connection;
      LFDQuery.SQL.Text :=
      ' SELECT '+
      '   prd.id_prd, '+
      '   prd.descricao_prd, '+
      '   prd.unidade_venda_prd, '+
      '   CASE  '+
      '     WHEN (CURRENT_DATE BETWEEN ale.inicio_promocao_ale AND ale.fim_promocao_ale)  '+
      '          AND (ale.preco_promocao_ale > 0) '+
      '     THEN ale.preco_promocao_ale '+
      '     ELSE ale.preco_venda_ale '+
      '   END AS preco_vigente, '+
      '   prd.url_imagem_prd '+
      ' FROM produtos prd '+
      ' INNER JOIN almoxarifados_estoque ale ON ale.id_prd = prd.id_prd '+
      ' WHERE prd.visivel_ecommerce_prd = TRUE '+
      '   AND ale.id_alm = 1 '
      ;

      if(AParametros.ContainsKey('descricao'))then
      begin
        LFDQuery.SQL.Add(' AND prd.descricao_prd CONTAINING :descricao ');
        LFDQuery.ParamByName('descricao').AsString := AParametros.Items['descricao'];
      end;

      if (AParametros.ContainsKey('limit')) then
      begin
        LFDQuery.SQL.Add(' OFFSET 0 ROWS FETCH NEXT :limit ROWS ONLY ');
        LFDQuery.ParamByName('limit').AsInteger := StrToIntDef(AParametros.Items['limit'], 12);
      end;

      LFDQuery.Open;
      JSONArray := LFDQuery.ToJSONArray;
    except
      raise EHorseException.New.Error('Ocorreu um erro no servidor!').Code(99)
    end;
  finally
    FreeAndNil(LFDQuery);

  end;
end;

end.
